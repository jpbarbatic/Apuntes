# Envío de ficheros

La subida de ficheros con PHP es una funcionalidad muy común en aplicaciones web: desde formularios de contacto con adjuntos, hasta gestores de imágenes, sistemas de documentos o perfiles de usuario con avatar.

## ¿Cómo funciona la subida de ficheros? 

1. El usuario selecciona un archivo en un formulario HTML.
2. El navegador lo envía al servidor mediante una petición POST con codificación especial (**enctype="multipart/form-data"**).
3. PHP lo recibe y lo almacena temporalmente en una carpeta del servidor.
4. El script PHP debe moverlo a una ubicación permanente (si cumple las reglas de seguridad).
     
**Ejemplo formulario**
```html
<form method="post" enctype="multipart/form-data" action="subir.php">
    <label>Selecciona un archivo:</label>
    <input type="file" name="archivo" required>
    <button type="submit">Subir</button>
</form>
```

**Atributos clave:**
- method="post" → obligatorio.
- enctype="multipart/form-data" → imprescindible para subir archivos.
- El **\<input>** debe tener un atributo name (ej: name="archivo").

## Cómo manejar la subida en PHP 

PHP almacena la información del archivo subido en la variable superglobal $_FILES. 
Estructura de $_FILES['nombre_del_input']: 

```php
$_FILES['archivo'] = [
    'name'     => 'foto.jpg',        // Nombre original
    'type'     => 'image/jpeg',      // Tipo MIME (¡NO FIABLE!)
    'size'     => 245678,            // Tamaño en bytes
    'tmp_name' => '/tmp/php12345',   // Ruta temporal en el servidor
    'error'    => 0                  // Código de error (0 = OK)
];
```

> ⚠️ **Importante**:  
> - `$_FILES['archivo']['type']` **NO es seguro** (lo envía el navegador y puede ser falsificado).  
> - **Nunca confíes en el nombre ni el tipo del archivo**.

Ejemplo básico de subida

### `subir.php`
```php
<?php
// Comprobamos que la petición se ha hecho por POST.
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $archivo = $_FILES['archivo'];

    // 1. Comprobar si hubo errores
    if ($archivo['error'] !== UPLOAD_ERR_OK) {
        die("Error al subir el archivo.");
    }

    // 2. Definir carpeta de destino
    $directorio = "uploads/";
    if (!is_dir($directorio)) {
        mkdir($directorio, 0755, true);
    }

    // 3. Generar un nombre seguro (¡no uses el original!)
    $nombre_seguro = uniqid() . "_" . basename($archivo['name']);
    $ruta_destino = $directorio . $nombre_seguro;

    // 4. Mover el archivo temporal a la carpeta definitiva
    if (move_uploaded_file($archivo['tmp_name'], $ruta_destino)) {
        echo "Archivo subido correctamente: <a href='$ruta_destino'>$nombre_seguro</a>";
    } else {
        die("No se pudo guardar el archivo.");
    }
}
?>
```

##Buenas prácticas de seguridad (¡ES CLAVE EN IAW!)

### ✅ 1. **Valida el tipo de archivo**
No uses `$_FILES['archivo']['type']`. Mejor:
- **Por extensión** (con lista blanca):
  ```php
  $extensiones_permitidas = ['jpg', 'jpeg', 'png', 'gif'];
  $ext = strtolower(pathinfo($archivo['name'], PATHINFO_EXTENSION));
  if (!in_array($ext, $extensiones_permitidas)) {
      die("Tipo de archivo no permitido.");
  }
  ```
- **Por contenido real** (más seguro):
  ```php
  $finfo = finfo_open(FILEINFO_MIME_TYPE);
  $mime = finfo_file($finfo, $archivo['tmp_name']);
  $tipos_permitidos = ['image/jpeg', 'image/png', 'image/gif'];
  if (!in_array($mime, $tipos_permitidos)) {
      die("Archivo no válido.");
  }
  finfo_close($finfo);
  ```

### ✅ 2. **Limita el tamaño**
```php
$tamano_max = 2 * 1024 * 1024; // 2 MB
if ($archivo['size'] > $tamano_max) {
    die("El archivo es demasiado grande.");
}
```

### ✅ 3. **Usa nombres de archivo seguros**
- Nunca uses `$_FILES['archivo']['name']` directamente.
- Usa `uniqid()`, `md5()`, o un UUID para evitar colisiones y ataques de path traversal.

### ✅ 4. **Almacena los archivos fuera de la raíz web (si es posible)**
- Si no necesitas servir el archivo directamente (ej: solo lo usa PHP), guárdalo **fuera de `public/` o `htdocs`**.
- Si debe ser accesible (ej: imágenes de perfil), al menos:
  - No permitas extensiones ejecutables (`.php`, `.js`, `.html`).
  - Sirve los archivos con un script PHP que valide permisos.

### ✅ 5. **Configuración de PHP (`php.ini`)**
Asegúrate de que en el servidor estén bien configuradas:
```ini
file_uploads = On
upload_max_filesize = 10M
post_max_size = 12M
max_file_uploads = 20
```
Estas opciones también se pueden modificar en tiempo de ejecución usando **ini_set()**
     
**Ejemplo**
```php
init_set('upload_max_filesize', '20M');
```