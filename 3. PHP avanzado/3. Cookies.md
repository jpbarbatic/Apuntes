# Cookies
El protocolo HTTP es un protocolo sin estado (stateless). Esto significa cada petición que se realiza es independiente de la anterior. Hemos visto que a través de la URL se puede pasar información, pero la URL tiene sus limitaciones, además que no es una forma muy segura.

Las **cookies HTTP** fueron introducidas en **1994**, y su implementación en los navegadores y servidores se popularizó a partir de **1995**.

### 🔹 Origen histórico

- **Inventor**: **Lou Montulli**, un ingeniero de software que trabajaba en **Netscape Communications**.
- **Motivación**: Resolver el problema de la **falta de estado** en el protocolo HTTP, que es inherentemente **stateless** (sin estado).  
  Por ejemplo, un servidor no podía recordar si un usuario ya se había autenticado o qué productos había puesto en un carrito de compras.

### 🔹 Primera implementación

- **1994**: Lou Montulli concibió la idea de las cookies para una tienda en línea de **MCI** que quería vender productos a través de la web.
- **1995**: Netscape Navigator 0.95 (una de las primeras versiones del navegador Netscape) fue el **primer navegador en implementar cookies**.
- El mecanismo usaba un encabezado HTTP llamado `Set-Cookie` (del servidor al cliente) y `Cookie` (del cliente al servidor).

### 🔹 Estandarización

Aunque nacieron como una propuesta de Netscape, las cookies pronto se convirtieron en un estándar de facto. Posteriormente fueron formalizadas por la **IETF** (Internet Engineering Task Force):

- **RFC 2109** (1997): Primera especificación oficial.
- **RFC 2965** (2000): Revisión y mejora.
- **RFC 6265** (abril de **2011**): Especificación actual y más ampliamente adoptada, titulada *"HTTP State Management Mechanism"*. Esta es la que define cómo funcionan las cookies en la web moderna.

---

### 🔹 ¿Por qué "cookie"?

El término **"cookie"** proviene de la informática general, donde se usaba para referirse a un **"paquete de datos intercambiado entre programas"**. A su vez, esto viene de la expresión **"magic cookie"**, usada en sistemas Unix para describir un token o dato que se pasa entre programas y que solo el emisor y receptor entienden.

---

### 🔹 Resumen cronológico

| Año | Evento |
|-----|--------|
| **1994** | Lou Montulli inventa las cookies en Netscape. |
| **1995** | Primera implementación en **Netscape Navigator**. |
| **1996** | Microsoft adopta cookies en **Internet Explorer 3**. |
| **1997** | Publicación del **RFC 2109** (primera estandarización). |
| **2011** | Publicación del **RFC 6265**, estándar actual. |

---

Hoy en día, las cookies son fundamentales para la web moderna, aunque su uso está cada vez más regulado por normativas como el **RGPD** (en Europa) y leyes de privacidad que exigen consentimiento explícito del usuario.

Las cookies en PHP son una forma de almacenar pequeños fragmentos de información en el navegador del usuario. Se utilizan comúnmente para recordar preferencias, mantener sesiones de usuario, rastrear comportamientos, entre otros fines. 


## 🍪 ¿Qué es una cookie?

Una **cookie** es un **pequeño archivo de texto** que un servidor web envía al navegador del usuario. El navegador lo almacena y, en futuras peticiones al mismo dominio, **lo devuelve automáticamente al servidor**.

> ✅ **Propósito**: mantener estado en un protocolo (HTTP) que es **sin estado** (*stateless*).

---

## 🔁 Flujo básico de una cookie

1. El servidor envía una cabecera HTTP:  
   `Set-Cookie: nombre=valor; expires=...; path=/; ...`
2. El navegador guarda la cookie.
3. En las siguientes peticiones a ese dominio, el navegador incluye:  
   `Cookie: nombre=valor`
4. PHP puede leerla con `$_COOKIE['nombre']`.


## 🔹 ¿Cómo se crean cookies en PHP?
```php
setcookie(nombre, valor, tiempo_expiración, ruta, dominio, seguro, sólo_http);
```
- nombre: nombre de la cookie.
- valor: valor que se almacena.
- tiempo_expiración: timestamp UNIX cuando expira (si es 0 o se omite, la cookie es de sesión y se borra al cerrar el navegador).
- ruta: ruta en el servidor donde la cookie estará disponible (por ejemplo, '/' para todo el sitio).
- dominio: dominio al que se enviará la cookie (por ejemplo, 'ejemplo.com').
- seguro: si es true, solo se envía por HTTPS.
- sólo_http: si es true, la cookie no es accesible mediante JavaScript (protege contra XSS).
    

> 
>⚠️ **Importante**:
> - `setcookie()` **debe llamarse antes de enviar cualquier salida HTML** (ni siquiera un espacio o salto de línea).  
> - Si no se especifica `tiempo_expiración`, la cookie es **de sesión** (se borra al cerrar el navegador).

---

## 📥 Cómo leer una cookie en PHP

Las cookies están disponibles en la **variable superglobal `$_COOKIE`**.

```php
if (isset($_COOKIE["usuario"])) {
    echo "Hola, " . htmlspecialchars($_COOKIE["usuario"]);
} else {
    echo "No estás identificado.";
}
```

> 🔒 **Siempre usa `htmlspecialchars()`** al mostrar datos de cookies para evitar XSS.

---

## 🧹 Cómo eliminar una cookie

Para eliminar una cookie, **se establece una fecha de expiración en el pasado**:

```php
// Eliminar la cookie "usuario"
setcookie("usuario", "", time() - 3600, "/");
```

> ✅ También puedes usar `unset($_COOKIE['usuario'])`, pero **esto solo la elimina en el script actual**, no en el navegador. Lo correcto es usar `setcookie()` con tiempo pasado.

---

## ⚙️ Parámetros avanzados de `setcookie()`

| Parámetro | Descripción | Recomendación en IAW |
|---------|-------------|----------------------|
| `nombre` | Nombre de la cookie | Usa nombres claros (`preferencia_tema`, `ultima_visita`) |
| `valor` | Valor a guardar | **Nunca almacenes datos sensibles** (contraseñas, emails sin cifrar) |
| `expires` | Fecha de expiración (timestamp) | Siempre define un tiempo razonable |
| `path` | Ruta donde es válida | Usa `"/"` para que sea accesible en todo el sitio |
| `domain` | Dominio (ej: `.midominio.com`) | Solo si necesitas compartir entre subdominios |
| `secure` | Solo por HTTPS | ✅ **`true` en producción** |
| `httponly` | No accesible desde JavaScript | ✅ **`true` siempre** (protege contra XSS) |

### Ejemplo seguro:
```php
setcookie(
    "tema", 
    "oscuro", 
    [
        'expires' => time() + 86400, // 1 día
        'path' => '/',
        'secure' => true,      // solo HTTPS
        'httponly' => true,    // no accesible desde JS
        'samesite' => 'Strict' // protección contra CSRF
    ]
);
```

> 💡 Desde PHP 7.3+, puedes usar un **array asociativo** para los parámetros (más legible).

---

## 🔒 Seguridad: buenas prácticas

1. **Nunca almacenes datos sensibles en cookies**  
   → Usa **sesiones** (`$_SESSION`) para datos privados (IDs de usuario, roles, etc.).

2. **Usa `HttpOnly = true`**  
   → Evita que JavaScript acceda a la cookie (protege contra ataques XSS).

3. **Usa `Secure = true` en producción**  
   → La cookie solo se envía por conexiones HTTPS.

4. **Valida y sanea siempre los valores de `$_COOKIE`**  
   → Al igual que `$_GET` y `$_POST`, pueden ser manipulados por el usuario.

5. **No confíes en las cookies para tomar decisiones críticas**  
   → Siempre verifica en el servidor (ej: si una cookie dice "es_admin", **no lo creas sin comprobar en la BBDD**).

---

